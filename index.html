<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ora√ß√£o de B√™n√ß√£o Divina</title>

  <style>
    :root {
      --overlay: rgba(0,0,0,.45);
      --card: rgba(17,24,39,.72);
      --muted: #cbd5e1;
      --text: #f1f5f9;
      --primary: #a7f3d0;
      --accent: #93c5fd;
      --danger: #fca5a5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      min-height: 100dvh;
      color: var(--text);
    }
    .bg {
      position: fixed;
      inset: 0;
      background: #0b1020 url('https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=1950&q=80') center/cover no-repeat;
    }
    .bg::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(2,6,23,.4), rgba(2,6,23,.75));
    }
    .wrap {
      position: relative;
      z-index: 1;
      display: grid;
      place-items: center;
      min-height: 100dvh;
      padding: 24px;
    }
    .card {
      width: min(860px, 96vw);
      background: var(--card);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      overflow: hidden;
    }
    .header { padding: 26px 26px 10px; }
    h1 { margin: 0 0 6px; font-size: 28px; letter-spacing: .2px; }
    p.desc { margin: 0; color: var(--muted); }
    p.desc b.highlight {
      color: #fcd34d;
      text-shadow: 0 0 8px rgba(252,211,77,0.7);
      animation: pulsarLuz 3s ease-in-out infinite;
    }
    @keyframes pulsarLuz {
      0%,100% { text-shadow: 0 0 8px rgba(252,211,77,0.7); }
      50% { text-shadow: 0 0 16px rgba(252,211,77,1); }
    }
    .content { padding: 18px 22px 6px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input, button {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.1);
      background: rgba(4,6,16,.75);
      color: var(--text);
      padding: 12px 14px;
      font-size: 15px;
    }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > * { flex: 1; }
    button.primary {
      background: linear-gradient(135deg, var(--primary), #34d399);
      border: none;
      font-weight: 700;
      color: #04140f;
      cursor: pointer;
      transition: all .3s ease;
    }
    button.primary:hover {
      box-shadow: 0 0 25px 6px rgba(52,211,153,0.4);
      transform: scale(1.02);
    }
    .cta-grid {
      display: grid;
      gap: 12px;
      margin-top: 12px;
      grid-template-columns: repeat(2,1fr);
    }
    @media(max-width:560px){.cta-grid{grid-template-columns:1fr;}}
    .linkbtn {
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all .25s ease;
      width: 100%;
      min-height: 48px;
    }
    .linkbtn.youtube { background: linear-gradient(135deg,#ff6b6b,#ff3b3b); color: #fff; }
    .linkbtn.whatsapp { background: linear-gradient(135deg,#34d399,#16a34a); color:#04140f; }
    .linkbtn.instagram { background: linear-gradient(135deg,#ff6db3,#e1306c); color:#fff; }
    .linkbtn.telegram { background: linear-gradient(135deg,#2AABEE,#229ED9); color:#fff; }

    /* Barra do topo com canal */
    .header-top { display:flex;align-items:center;justify-content:space-between;gap:12px; }
    .badge {
      font-weight:700;
      color:#e2e8f0;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 12px;
      border-radius:10px;
    }
    .channel-icon {
      display:inline-flex;align-items:center;gap:10px;text-decoration:none;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;border-radius:12px;
      transition:transform .2s ease, border-color .2s ease;
    }
    .channel-icon:hover { transform:translateY(-1px); border-color:rgba(255,255,255,.25); }
    .channel-icon img { width:48px;height:48px;border-radius:10px;display:block; }
    .channel-icon span { color:#e2e8f0;font-weight:700;white-space:nowrap; }
    @media (max-width:480px){ .channel-icon span { display:none; } }
  </style>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1020">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
</head>

<body>
  <div class="bg"></div>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="header-top">
          <div class="badge">Sua Jornada Seu Destino</div>
          <a class="channel-icon" href="https://www.youtube.com/@suajornadaseudestino" target="_blank" rel="noopener">
            <img src="./icons/canal.png" alt="√çcone do Canal">
            <span>Canal</span>
          </a>
        </div>
        <h1>Ora√ß√£o de B√™n√ß√£o Divina</h1>
        <p class="desc">Digite o nome de quem ser√° aben√ßoado e clique em <b class="highlight">Ouvir Ora√ß√£o</b>.</p>
      </div>

      <div class="content">
        <label for="nome">Nome a receber a Ben√ß√£o!</label>
        <input id="nome" placeholder="Ex.: Ana Clara" />
        <div style="height:10px"></div>
        <div class="row">
          <button id="btn-ouvir" class="primary">üéß Ouvir ora√ß√£o</button>
          <a id="btn-download" class="secondary" style="display:none" download>‚¨áÔ∏è Baixar √∫ltimo √°udio (MP3)</a>
        </div>
        <div class="cta-grid">
          <a class="linkbtn youtube" href="https://www.youtube.com/@suajornadaseudestino" target="_blank">‚ñ∂Ô∏è Canal Sua Jornada</a>
          <button id="btn-whats" class="linkbtn whatsapp">üü¢ Compartilhar no WhatsApp</button>
          <a class="linkbtn instagram" href="https://www.instagram.com/suajornadaseudestino/" target="_blank">üì∏ Instagram Sua Jornada</a>
          <button id="btn-telegram" class="linkbtn telegram">‚úàÔ∏è Compartilhar no Telegram</button>
        </div>
      </div>

      <div class="player">
        <audio id="player" controls style="width:100%"></audio>
      </div>
      <div class="status" id="status">Pronto. Digite o <b>nome</b> e clique em <b>Ouvir ora√ß√£o</b>.</div>
    </div>
  </div>

  <!-- ‚úÖ SCRIPT FINAL POSICIONADO CORRETAMENTE -->
  <script>
    const ENDPOINT = "https://oracaooo.onrender.com/tts";
    const DEFAULT_VOICE_ID = "4YYIPFl9wE5c4L2eu2Gb";
    const DEFAULT_PRAYER_TEXT = `{{nome}} Respire fundo... Agora, receba esta ora√ß√£o.

{{nome}}, o Senhor te chama pelo nome. Que a paz que excede todo entendimento preencha o teu cora√ß√£o. Onde houver medo, que entre a confian√ßa; onde houver dor, que flores√ßa cura; onde houver d√∫vida, que se levante a f√©.

{{nome}}, que a luz de Deus ilumine teus passos hoje e sempre. Am√©m.`;

    const nomeInput = document.getElementById('nome');
    const statusEl  = document.getElementById('status');
    const player    = document.getElementById('player');
    const btnOuvir  = document.getElementById('btn-ouvir');
    const btnWhats  = document.getElementById('btn-whats');
    const btnTg     = document.getElementById('btn-telegram');
    const SITE_URL  = window.location.href.split('#')[0];

    function montarMsg(nome) {
      const s = nome ? `${nome}, ` : '';
      return `${s}receba esta Ora√ß√£o de B√™n√ß√£o Divina üôè\n\nOu√ßa sua ora√ß√£o aqui:\n${SITE_URL}\n\nQue Deus ilumine seus passos hoje e sempre. Am√©m.`;
    }

    async function fetchTTSAudio({ text, voiceId, tries = 4, timeoutMs = 15000 }) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const r = await fetch(ENDPOINT + `?t=${Date.now()}`, {
          method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, voiceId }), signal: controller.signal
        });
        clearTimeout(t);
        if (!r.ok) throw new Error(`Erro ${r.status}`);
        const blob = await r.blob();
        if (!blob.size) throw new Error('Resposta vazia do servidor TTS');
        return new Blob([blob], { type: 'audio/mpeg' });
      } catch (e) {
        if (tries > 1) {
          const wait = Math.pow(2, 4 - tries) * 500;
          await new Promise(res => setTimeout(res, wait));
          return fetchTTSAudio({ text, voiceId, tries: tries - 1, timeoutMs });
        }
        throw e;
      }
    }

    async function gerarAudio() {
      const nome  = (nomeInput.value || '').trim();
      const texto = DEFAULT_PRAYER_TEXT.replace(/\{\{\s*nome\s*\}\}/gi, nome || '');
      statusEl.textContent = 'üôè Preparando a ora√ß√£o...';
      btnOuvir.disabled = true;
      try {
        const audioBlob = await fetchTTSAudio({ text: texto, voiceId: DEFAULT_VOICE_ID });
        const url = URL.createObjectURL(audioBlob);
        player.src = url;
        try { await player.play(); } catch {}
        const btnDownload = document.getElementById('btn-download');
        if (btnDownload) {
          const nomeArquivo = `oracao-${(nome || 'bencao').toLowerCase().replace(/\s+/g,'-')}.mp3`;
          btnDownload.href = url;
          btnDownload.download = nomeArquivo;
          btnDownload.style.display = 'inline-block';
        }
        statusEl.textContent = '‚ú® Ora√ß√£o gerada com sucesso!';
      } catch (err) {
        console.error('[TTS] Falha:', err);
        const msg = (err.name === 'AbortError')
          ? 'Tempo esgotado ao gerar o √°udio. Tente novamente.'
          : (String(err.message||'').includes('CORS') ? 'Bloqueado por CORS no servidor TTS.' : `Falha ao gerar: ${err.message}`);
        statusEl.innerHTML = `<span class="error">${msg}</span>`;
      } finally {
        btnOuvir.disabled = false;
      }
    }

    btnOuvir?.addEventListener('click', gerarAudio);
    btnWhats?.addEventListener('click', () => {
      const msg = montarMsg((nomeInput.value||'').trim());
      if (navigator.share) {
        navigator.share({ text: msg, url: SITE_URL, title: 'Ora√ß√£o de B√™n√ß√£o Divina' }).catch(()=>{});
        return;
      }
      window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank', 'noopener');
    });
    btnTg?.addEventListener('click', () => {
      const msg = montarMsg((nomeInput.value||'').trim());
      window.open(`https://t.me/share/url?url=${encodeURIComponent(SITE_URL)}&text=${encodeURIComponent(msg)}`, '_blank', 'noopener');
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(console.error);
    }
  </script>
</body>
</html>
