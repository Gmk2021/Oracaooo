<script>
  // --- Constantes
  const ENDPOINT = "https://oracaooo.onrender.com/tts";
  const DEFAULT_VOICE_ID = "4YYIPFl9wE5c4L2eu2Gb";
  const DEFAULT_PRAYER_TEXT = `{{nome}} Respire fundo... Agora, receba esta ora√ß√£o.

{{nome}}, o Senhor te chama pelo nome. Que a paz que excede todo entendimento preencha o teu cora√ß√£o. Onde houver medo, que entre a confian√ßa; onde houver dor, que flores√ßa cura; onde houver d√∫vida, que se levante a f√©.

{{nome}}, que a luz de Deus ilumine teus passos hoje e sempre. Am√©m.`;

  // --- Elementos
  const nomeInput = document.getElementById('nome');
  const statusEl  = document.getElementById('status');
  const player    = document.getElementById('player');
  const btnOuvir  = document.getElementById('btn-ouvir');
  const btnWhats  = document.getElementById('btn-whats');
  const btnTg     = document.getElementById('btn-telegram');
  const SITE_URL  = window.location.href.split('#')[0];

  // --- Mensagem para compartilhamento
  function montarMsg(nome) {
    const s = nome ? `${nome}, ` : '';
    return `${s}receba esta Ora√ß√£o de B√™n√ß√£o Divina üôè\n\nOu√ßa sua ora√ß√£o aqui:\n${SITE_URL}\n\nQue Deus ilumine seus passos hoje e sempre. Am√©m.`;
  }

  // --- Chamada TTS com retry e timeout
  async function fetchTTSAudio({ text, voiceId, tries = 4, timeoutMs = 15000 }) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs);

    try {
      const r = await fetch(ENDPOINT + `?t=${Date.now()}`, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, voiceId }),
        signal: controller.signal
      });
      clearTimeout(t);

      if (!r.ok) {
        let msg = `Erro ${r.status}`;
        try { const j = await r.json(); if (j?.error) msg += ` ‚Äî ${j.error}`; } catch {}
        throw new Error(msg);
      }
      const blob = await r.blob();
      if (!blob || blob.size === 0) throw new Error('Resposta vazia do servidor TTS');
      return new Blob([blob], { type: 'audio/mpeg' });
    } catch (e) {
      if (tries > 1) {
        const wait = Math.pow(2, 4 - tries) * 500; // 500ms, 1s, 2s‚Ä¶
        await new Promise(res => setTimeout(res, wait));
        return fetchTTSAudio({ text, voiceId, tries: tries - 1, timeoutMs });
      }
      throw e;
    }
  }

  // --- Gerar e tocar √°udio
  async function gerarAudio() {
    const nome  = (nomeInput.value || '').trim();
    const texto = DEFAULT_PRAYER_TEXT.replace(/\{\{\s*nome\s*\}\}/gi, nome || '');
    statusEl.textContent = 'üôè Preparando a ora√ß√£o...';
    btnOuvir.disabled = true;

    try {
      const audioBlob = await fetchTTSAudio({ text: texto, voiceId: DEFAULT_VOICE_ID });
      const url = URL.createObjectURL(audioBlob);

      player.src = url;
      try { await player.play(); } catch {}

      const btnDownload = document.getElementById('btn-download');
      if (btnDownload) {
        const nomeArquivo = `oracao-${(nome || 'bencao').toLowerCase().replace(/\s+/g,'-')}.mp3`;
        btnDownload.href = url;
        btnDownload.download = nomeArquivo;
        btnDownload.style.display = 'inline-block';
      }
      statusEl.textContent = '‚ú® Ora√ß√£o gerada com sucesso!';
    } catch (err) {
      console.error('[TTS] Falha:', err);
      const msg = (err.name === 'AbortError')
        ? 'Tempo esgotado ao gerar o √°udio. Tente novamente.'
        : (String(err.message||'').includes('CORS') ? 'Bloqueado por CORS no servidor TTS.' : `Falha ao gerar: ${err.message}`);
      statusEl.innerHTML = `<span class="error">${msg}</span>`;
    } finally {
      btnOuvir.disabled = false;
    }
  }

  // --- Listeners
  btnOuvir?.addEventListener('click', gerarAudio);

  btnWhats?.addEventListener('click', () => {
    const msg = montarMsg((nomeInput.value||'').trim());
    if (navigator.share) {
      navigator.share({ text: msg, url: SITE_URL, title: 'Ora√ß√£o de B√™n√ß√£o Divina' }).catch(()=>{});
      return;
    }
    const wa = 'https://wa.me/?text=' + encodeURIComponent(msg);
    window.open(wa, '_blank', 'noopener');
  });

  btnTg?.addEventListener('click', () => {
    const msg = montarMsg((nomeInput.value||'').trim());
    const tg  = `https://t.me/share/url?url=${encodeURIComponent(SITE_URL)}&text=${encodeURIComponent(msg)}`;
    window.open(tg, '_blank', 'noopener');
  });

  // --- Service Worker + cart√£o de atualiza√ß√£o (vers√£o √∫nica)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").then((reg) => {
      reg.addEventListener("updatefound", () => {
        const nw = reg.installing;
        nw.addEventListener("statechange", () => {
          if (nw.state === "installed" && navigator.serviceWorker.controller) {
            const box = document.createElement("div");
            box.innerHTML = `
              <div id="update-card" style="
                position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
                background: rgba(15,23,42,.92); color: #e2e8f0;
                padding: 14px 18px; border-radius: 14px;
                box-shadow: 0 10px 30px rgba(0,0,0,.45);
                display: flex; align-items: center; gap: 12px; z-index: 9999;
                border: 1px solid rgba(255,255,255,.08);
                animation: fadeInUp .5s ease forwards; opacity: 0;
              ">
                <span style="font-size: 18px;">‚ú®</span>
                <span style="font-weight:700">Nova vers√£o dispon√≠vel</span>
                <button id="refresh-btn" style="
                  margin-left: 8px; background: linear-gradient(135deg,#fcd34d,#f59e0b);
                  color: #1f2937; border: none; padding: 8px 12px; font-weight: 800;
                  border-radius: 10px; cursor: pointer;
                ">Atualizar agora</button>
              </div>
              <style>
                @keyframes fadeInUp { from { opacity:0; transform: translate(-50%, 12px);} to { opacity:1; transform: translate(-50%, 0);} }
                #refresh-btn:hover { filter: brightness(1.05); }
              </style>
            `;
            document.body.appendChild(box);

            const card = document.getElementById("update-card");
            const btn  = document.getElementById("refresh-btn");
            btn.onclick = () => {
              nw.postMessage({ type: "CHECK_VERSION" });
              card.style.opacity = "0";
              setTimeout(() => window.location.reload(), 400);
            };
            setTimeout(() => card?.remove(), 15000);
          }
        });
      });
    }).catch(console.error);
  }
</script>
